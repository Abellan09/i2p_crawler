<!DOCTYPE html>

<head>

	<meta charset="utf-8">
	<title>I2P DARKNET MAP</title>
	<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
	<link rel="stylesheet" type="text/css" href="eepsite.css">
	<link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="/favicon/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
	<link rel="manifest" href="/favicon/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/favicon/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">
	<style>
		.links line {
			stroke: #999;
			stroke-opacity: 0.6;
		}
		.nodes circle {
			stroke: #fff;
			stroke-width: 1.5px;
		}	
		svg {
			width: 100%; height: auto;
		}
	</style>
	
</head>

<body>

	<div class="main">
		<div id="navbar">
			<a href="/index.html">Map View</a>
			<a href="/top.html">Top Sites</a>
			<a href="https://geti2p.net" target="_blank">I2P Site</a>
			<a href="https://github.com/Abellan09/tfg_crawler_i2p" target="_blank">Proyect's GitHub</a>
		</div>
		<a href="."><h1>I2P DARKNET MAP</h1></a>
		<h2>This page shows the I2P's eepsites connectivity map</h2>
		<div class="subtitle" id="nodeinfo">
			<u>NODE INFORMATION</u>
			<p id="info">Click on any node in order to view its main information.</p>
		</div>
		<div id="map" class="subtitle">
			EEPSITES' CONNECTIVITY MAP
		</div>
		<div class="notify">
			<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="960" height="800" viewBox="0 0 960 400" preserveAspectRatio="xMinYMin meet"></svg>
		</div> 
		<hr>
		<div class="footnote">	
			Author: Ast4Th0r.
		</div>
	</div>
	
	<script>
	
		var svg = d3.select("svg"); // se selecciona el elemento svg y se crea una referencia
		var width = svg.attr("width"); // se crea una referencia al valor de la anchura del svg
		var	height = svg.attr("height"); // se crea una referencia al valor de la altura del svg

		var color = d3.scaleOrdinal(d3.schemeCategory20); // se define una escala de tipo "ordinal" con una paleta de 20 colores y se crea una referencia a ella

		var simulation = d3.forceSimulation() // se define una simulación (que comienza inmediatamente) y se crea una referencia a ella
			.force("link", d3.forceLink().id(function(d) { return d.id; }))
			.force("charge", d3.forceManyBody())
			.force("center", d3.forceCenter(width/2, height/2.5));

		d3.json("i2p_data.json", function(error, graph) { // obtiene el archivo json especificado "i2p.json" y ejecuta la función principal
		  if (error) throw error; // lanza una excepción si se produce un error

		  var link = svg.append("g")
			  .attr("class", "links") // le asigna el estilo CSS de la clase links
			.selectAll("line")
			.data(graph.links) // "pasa" por cada uno de los datos (los "datos links" en este caso) y crea un elemento link para cada uno
			.enter().append("line")
			  .attr("stroke-width", function(d) { return Math.sqrt(2); });

		  var node = svg.append("g")
			  .attr("class", "nodes") // le asigna el estilo CSS de la clase nodes
			.selectAll("circle")
			.data(graph.nodes) // "pasa" por cada uno de los datos (los "datos nodos" en este caso) y crea un elemento círculo para cada uno
			.enter().append("circle")
			  .on("click", function (d, i) {
				var data = d.id;
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
					  document.getElementById("info").innerHTML = this.responseText;
					}
				};
				xhttp.open("POST", "reaction.php", true);
				xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xhttp.send("bola=" +data);
				location.href="#nodeinfo";
				})
			  .attr("r", function(d) { return d.incoming_sites*2; }) // se define el valor del radio del nodo en función de sus incoming_sites
			  .attr("fill", function(d) { return color(d.incoming_sites); })
			  .attr("id", function(d) { return d.id; })
			  .call(d3.drag() // para crear el comportamiento de arrastre (el drag que d3.drag() devuelve es a la vez un objeto y una función)
				  .on("start", dragstarted)
				  .on("drag", dragged)
				  .on("end", dragended));
		  
		  node.append("title") // añade el atributo título a cada nodo
			  .text(function(d) { return d.name; });

		  simulation // ejecuta simulación referente a los nodos
			  .nodes(graph.nodes)
			  .on("tick", ticked);

		  simulation.force("link") // ejecuta simulación referente a los links
			  .links(graph.links);

		  function ticked() { // asigna los atributos correspondientes a las coordenadas de las rectas (links) y los círculos (nodos)
			link
				.attr("x1", function(d) { return d.source.x; })
				.attr("y1", function(d) { return d.source.y; })
				.attr("x2", function(d) { return d.target.x; })
				.attr("y2", function(d) { return d.target.y; });

			node
				.attr("cx", function(d) { return d.x; })
				.attr("cy", function(d) { return d.y; });
		  }
		  
		});

		function dragstarted(d) {
		  if (!d3.event.active) simulation.alphaTarget(0.3).restart(); // si no hay ningún evento evento activo, reinicia la simulación con un alfa de 0.3
		  d.fx = d.x;
		  d.fy = d.y;
		}

		function dragged(d) {
		  d.fx = d3.event.x;
		  d.fy = d3.event.y;
		}

		function dragended(d) {
		  if (!d3.event.active) simulation.alphaTarget(0); // si no hay ningún evento activo, pone alfa a 0 ("detiene" la simulación)
		  d.fx = null;
		  d.fy = null;
		}

	</script>
	
</body>

